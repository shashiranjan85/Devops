#/bin/bash
Private_IP="10.0.3.153"

echo -n "Generating RSA key pair....."
ssh-keygen -t rsa -N "" -f .ssh/id_rsa
echo "Done"
echo -n "Copying id_rsa.pub file to $Private_IP:/home/ubuntu/....."
scp -i "/home/ubuntu/test123.pem" "/home/ubuntu/.ssh/id_rsa.pub" ubuntu@$Private_IP:/home/ubuntu/
echo "Done"
echo -n "Adding to known hosts...."
ssh-keyscan $Private_IP >> $HOME/.ssh/known_hosts
echo "Done"
echo -n "ssh to $Private_IP with pem file and adding id_rsa.pub to authorized_keys ....."
ssh -i "test123.pem" ubuntu@$Private_IP << EOF
cat /home/ubuntu/id_rsa.pub >> /home/ubuntu/.ssh/authorized_keys
exit
EOF
echo "Done"

echo -n "ssh without passing any key and installing apache...."
cd /home/ubuntu/.ssh
ssh $Private_IP << EOF
echo -n "system update..."
sudo apt-get update -y
echo "Done"
echo -n "installing apache...."
sudo apt-get install apache2 -y
echo "Done"
EOF

echo "Done"
